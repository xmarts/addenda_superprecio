<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data noupdate="0">
        <template id="addenda_superprecio" name="Super precio C">
            <t t-foreach="record" t-as="tt">
                <t t-if="tt.move_type == 'out_invoice'">
                    <ap:ap xmlns:ap="http://www.tiendasneto.com/ap" t-att-observaciones="str(record.text_from_html(record.narration)) if len(record.text_from_html(record.narration)) > 1 else None" t-att-plazoPago="record.invoice_payment_term_id.name" tipoComprobante="FE">
                        <t t-foreach="record" t-as="t">
                            <t t-if="t.move_type == 'out_invoice'">
                                <ap:Detalle t-att-folio="record.fields_sales.number_order">
                                    <t t-set="xml" t-value="record._get_values_addenda()"/>
                                    <t t-set="format_float" t-value="xml.get('format_float')"/>
                                    <t t-set="format_string" t-value="xml.get('format_string')"/>
                                    <t t-set="tax_objected" t-value="xml.get('tax_objected')"/>
                                    <t t-set="currency_precision" t-value="xml.get('currency_precision')"/>
                                    <t t-foreach="record.invoice_line_ids" t-as="rec">
                                        <t t-set="units" t-value="rec.product_id.product_units"/>
                                        <t t-if="units == False">
                                            <t t-set="units" t-value="0"/>
                                        </t>
                                        <t t-foreach="xml.get('invoice_line_vals_list')" t-as="line_vals">
                                            <t t-set="line" t-value="line_vals['line']"/>
                                            <t t-if="format_string(line.product_id.barcode) == rec.product_id.barcode">
                                                <!-- FIXME: Revisar esta parte -->
                                                <!-- <t t-set="valprecre" t-value="format_float(line_vals['gross_price_total_unit'] if tax_objected == '02' else (line.price_total + line_vals['price_discount']) / line.quantity, currency_precision)"/> -->
                                                <t t-set="valprecre" t-value="format_float(rec.price_unit, currency_precision)"/>
                                            </t>
                                        </t>
                                        <t t-set="piez_ent" t-value="int(units) * rec.quantity"/>
                                        <t t-set="oper1" t-value="float(valprecre) * rec.quantity"/>
                                        <t t-set="oper2" t-value="oper1 / piez_ent"/>
                                        <t t-set="cant" t-value="rec.quantity"/>
                                        <ap:Producto t-att-precioUnitarioPieza="'%.4f'% oper2" t-att-piezasEntregadas="int(piez_ent)" t-att-precioUnitarioCaja="'%.4f'% float(valprecre)" t-att-cajasEntregadas="int(rec.quantity)" t-att-codigoBarras="rec.product_id.barcode">
                                            <t t-set="cont" t-value="0"/>
                                            <t t-foreach="rec.tax_ids" t-as="tc">
                                                <!-- FIXME: Revisar esta parte -->
                                                <t t-if="record.partner_id.show_ieps == False">
                                                    <t t-if="tc.ieps == False">
                                                        <t t-if="tc.amount != 0">
                                                            <t t-set="resultimp" t-value="float(valprecre)"/>
                                                            <!-- <t t-set="resoperimp" t-value="resultimp * (tc.amount / 100)"/> -->
                                                            <t t-set="resoperimp" t-value="(cant * resultimp/1.16)*0.16"/>
                                                            <t t-set="cont" t-value="cont + resoperimp"/>
                                                        </t>
                                                    </t>
                                                </t>
                                            </t>
                                            <t t-set="cont" t-value="cont * cant"/>
                                            <ap:Impuestos t-att-totalImpuestosTrasladados="'%.4f'% cont">
                                                <ap:Traslados>
                                                    <t t-foreach="rec.tax_ids" t-as="tac">
                                                        <t t-set="resultimpuest" t-value="float(valprecre)"/>
                                                        <!-- FIXME: Revisar esta parte -->
                                                        <t t-if="record.partner_id.show_ieps == False">
                                                            <t t-if="tac.ieps == False">
                                                                <t t-if="tac.amount != 0">
                                                                    <!-- <t t-set="var" t-value="resultimpuest * (tac.amount / 100)"/>
                                                                    <t t-set="opvar" t-value="var * cant"/> -->
                                                                    <t t-set="opvar" t-value="(cant * resultimpuest/1.16)*0.16"/>
                                                                    <!-- <t t-set="opvar" t-value="(cant * resultimpuest/(tac.amount + 1))*(tac.amount / 100)"/> -->
                                                                    <ap:Traslado t-att-impuesto="'IVA'" t-att-tasa="'%.2f'% tac.amount" t-att-importe="'%.4f'% opvar"/>
                                                                </t>
                                                            </t>
                                                            <t t-if="tac.description[0:3] == 'IVA'">
                                                                <t t-if="tac.amount != 0">
                                                                    <!-- <t t-set="var" t-value="resultimpuest * (tac.amount / 100)"/>
                                                                    <t t-set="opvar" t-value="var * cant"/> -->
                                                                    <t t-set="opvar" t-value="(cant * resultimpuest/1.16)*0.16"/>
                                                                    <ap:Traslado t-att-impuesto="'IVA'" t-att-tasa="'%.2f'% tac.amount" t-att-importe="'%.4f'% opvar"/>
                                                                </t>
                                                               <t t-if="tac.amount == 0">
                                                                  <ap:Traslado t-att-impuesto="'IVA'" t-att-tasa="'0.0000'" t-att-importe="'0.00'"/>
                                                                </t>
                                                            </t>
                                                            
                                                        </t>
                                                        <t t-else="">
                                                            <t t-if="tac.description[0:3] == 'IVA'">
                                                                <t t-if="tac.amount != 0">
                                                                    <!-- <t t-set="var" t-value="resultimpuest * (tac.amount / 100)"/>
                                                                    <t t-set="opvar" t-value="var * cant"/> -->
                                                                    <t t-set="opvar" t-value="(cant * resultimpuest/1.16)*0.16"/>
                                                                    <ap:Traslado t-att-impuesto="'IVA'" t-att-tasa="'%.2f'% tac.amount" t-att-importe="'%.4f'% opvar"/>
                                                                </t>
                                                               <t t-if="tac.amount == 0">
                                                                  <ap:Traslado t-att-impuesto="'IVA'" t-att-tasa="0.0000" t-att-importe="0.00"/>
                                                                </t>
                                                            </t>
                                                            <t t-if="tac.ieps == True">
                                                                <!-- <impuesto t-esc="tag.name"/>
                                                                <importe t-esc="tac.amount"/> -->
                                                                <impuesto t-esc="'IEPS'"/>
                                                                <importe t-esc="0"/>
                                                                <Traslado t-att-impuesto="'IEPS'" t-att-tasa="'%.2f'% tac.amount" t-att-importe="'%.4f'% 0"/>
                                                            </t>
                                                        </t>
                                                    </t>
                                                </ap:Traslados>
                                            </ap:Impuestos>
                                        </ap:Producto>
                                    </t>
                                </ap:Detalle>
                            </t>
                        </t>
                    </ap:ap>
                </t>
                <t t-if="tt.move_type == 'out_refund'">
                    <ap:ap xmlns:ap="http://www.tiendasneto.com/ap" t-att-observaciones="str(record.text_from_html(record.narration)) if len(record.text_from_html(record.narration)) > 1 else None" t-att-plazoPago="record.invoice_payment_term_id.name" tipoComprobante="NC">
                        <ap:Detalle t-att-folio="record.fields_sales.number_order">
                            <t t-set="xml" t-value="record._get_values_addenda()"/>
                            <t t-set="format_float" t-value="xml.get('format_float')"/>
                            <t t-set="format_string" t-value="xml.get('format_string')"/>
                            <t t-set="tax_objected" t-value="xml.get('tax_objected')"/>
                            <t t-set="currency_precision" t-value="xml.get('currency_precision')"/>
                            <t t-foreach="record.invoice_line_ids" t-as="rec">
                                <t t-set="units" t-value="rec.product_id.product_units"/>
                                <t t-if="units == False">
                                    <t t-set="units" t-value="0"/>
                                </t>
                                <t t-set="valprecre" t-value="0"/>
                                <t t-foreach="xml.get('invoice_line_vals_list')" t-as="line_vals">
                                    <t t-set="line" t-value="line_vals['line']"/>
                                   <t t-if="format_string(line.product_id.barcode) == rec.product_id.barcode">
                                        <!-- FIXME: Revisar esta parte -->
                                        <!-- <t t-set="valprecre" t-value="format_float(line_vals['gross_price_total_unit'] if tax_objected == '02' else (line.price_total + line_vals['price_discount']) / line.quantity, currency_precision)"/> -->
                                        <t t-set="valprecre" t-value="format_float(rec.price_unit, currency_precision)"/>
                                    </t>
                                </t>
                                <t t-set="piez_ent" t-value="int(units) * rec.quantity"/>
                                <t t-set="oper1" t-value="float(valprecre) * rec.quantity"/>
                                <t t-set="oper2" t-value="oper1 / piez_ent"/>
                                <t t-set="cant" t-value="rec.quantity"/>
                                <ap:Producto t-att-precioUnitarioPieza="'%.4f'% oper2" t-att-piezasEntregadas="int(piez_ent)" t-att-precioUnitarioCaja="'%.4f'% float(valprecre)" t-att-cajasEntregadas="int(rec.quantity)" t-att-codigoBarras="rec.product_id.barcode">
                                    <t t-set="cont" t-value="0"/>
                                    <t t-foreach="rec.tax_ids" t-as="tc">
                                        <!-- FIXME: Revisar esta parte -->
                                        <t t-if="record.partner_id.show_ieps == False">
                                            <t t-if="tc.ieps == False">
                                                <t t-if="tc.amount != 0">
                                                    <t t-set="resultimp" t-value="float(valprecre)"/>
                                                    <!-- <t t-set="resoperimp" t-value="resultimp * (tc.amount / 100)"/> -->
                                                    <t t-set="resoperimp" t-value="(cant * resultimp/1.16)*0.16"/>
                                                    <t t-set="cont" t-value="cont + resoperimp"/>
                                                </t>
                                            </t>
                                        </t>
                                    </t>
                                    <t t-set="cont" t-value="cont * cant"/>
                                    <ap:Impuestos t-att-totalImpuestosTrasladados="'%.4f'% cont">
                                        <ap:Traslados>
                                            <t t-foreach="rec.tax_ids" t-as="tac">
                                                <t t-set="resultimpuest" t-value="float(valprecre)"/>
                                                <!-- FIXME: Revisar esta parte -->
                                                <t t-if="record.partner_id.show_ieps == False">
                                                    <t t-if="tac.ieps == False">
                                                        <t t-if="tac.amount != 0">
                                                            <!-- <t t-set="var" t-value="resultimpuest * (tac.amount / 100)"/>
                                                            <t t-set="opvar" t-value="var * cant"/> -->
                                                            <t t-set="opvar" t-value="(cant * resultimpuest/1.16)*0.16"/>
                                                            <!-- <t t-set="opvar" t-value="(cant * resultimpuest/(tac.amount + 1))*(tac.amount / 100)"/> -->
                                                            <ap:Traslado t-att-impuesto="'IVA'" t-att-tasa="'%.2f'% tac.amount" t-att-importe="'%.4f'% opvar"/>
                                                        </t>
                                                    </t>
                                                    <t t-if="tac.description[0:3] == 'IVA'">
                                                        <t t-if="tac.amount != 0">
                                                            <!-- <t t-set="var" t-value="resultimpuest * (tac.amount / 100)"/>
                                                            <t t-set="opvar" t-value="var * cant"/> -->
                                                            <t t-set="opvar" t-value="(cant * resultimpuest/1.16)*0.16"/>
                                                            <ap:Traslado t-att-impuesto="'IVA'" t-att-tasa="'%.2f'% tac.amount" t-att-importe="'%.4f'% opvar"/>
                                                        </t>
                                                       <t t-if="tac.amount == 0">
                                                          <ap:Traslado t-att-impuesto="'IVA'" t-att-tasa="'0.0000'" t-att-importe="'0.00'"/>
                                                        </t>
                                                    </t>
                                                </t>
                                                <t t-else="">
                                                    <t t-if="tac.description[0:3] == 'IVA'">
                                                        <t t-if="tac.amount != 0">
                                                            <!-- <t t-set="var" t-value="resultimpuest * (tac.amount / 100)"/>
                                                            <t t-set="opvar" t-value="var * cant"/> -->
                                                            <t t-set="opvar" t-value="(cant * resultimpuest/1.16)*0.16"/>
                                                            <ap:Traslado t-att-impuesto="'IVA'" t-att-tasa="'%.2f'% tac.amount" t-att-importe="'%.4f'% opvar"/>
                                                        </t>
                                                        <t t-if="tac.amount == 0">
                                                          <ap:Traslado t-att-impuesto="'IVA'" t-att-tasa="0.0000" t-att-importe="0.00"/>
                                                        </t>
                                                    </t>
                                                    <t t-if="tac.ieps == True">
                                                        <!-- <impuesto t-esc="tag.name"/>
                                                        <importe t-esc="tac.amount"/> -->
                                                        <impuesto t-esc="'IEPS'"/>
                                                        <importe t-esc="0"/>
                                                        <Traslado t-att-impuesto="'IEPS'" t-att-tasa="'%.2f'% tac.amount" t-att-importe="'%.4f'% 0"/>
                                                    </t>
                                                </t>
                                            </t>
                                        </ap:Traslados>
                                    </ap:Impuestos>
                                </ap:Producto>
                            </t>
                        </ap:Detalle>
                    </ap:ap>
                </t>
            </t>
        </template>
        <record id="addenda_superprecio" model="ir.ui.view">
            <field name="l10n_mx_edi_addenda_flag">True</field>
        </record>
    </data>
</odoo>